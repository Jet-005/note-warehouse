

## 3.1 传输层基本服务
- **核心功能**（P91）
  - 进程间端到端通信
  - 报文分段与重组
  - 差错检测与恢复
  - 复用与分解
  - 流量控制
  - 拥塞控制
- **传输单元**：报文段（segment）
- **协议类型**
  - TCP：可靠数据传输服务
  - UDP：不可靠数据传输服务
- **寻址机制**
  - 标识：IP地址 + 端口号
  - 端口号分类：
    - 熟知端口（0~1023）
    - 登记端口（1024~49151）
    - 临时端口（49152~65535）
- **逻辑通信**
  - 通信端点：主机内的进程（非主机）
  - 网络层vs传输层：
    - 网络层：提供主机间通信
    - 传输层：提供进程间通信

## 3.2 复用与分解
- **基本概念**
  - 复用：多个应用进程共用传输层协议（应用层→传输层）
  - 分解：传输层将数据交付不同应用进程（传输层→应用层）
  - 核心：通过端口号唯一标识套接字
- **UDP复用与分解**
  - 套接字标识：二元组（目的IP地址 + 目的端口号）
  - 实现机制：
    - 不同目的端口号：实现分解
    - 不同源IP地址：实现复用
  - 端口分配方式：
    - 自动分配（1024~65535）
    - 绑定特定端口（bind函数）
- **TCP复用与分解**
  - 套接字标识：四元组（源IP + 源端口 + 目的IP + 目的端口）
  - 特点：任一元素不同即构成不同连接
- **对比**
  - UDP：无连接，仅基于目的地址和端口
  - TCP：面向连接，需完整四元组标识

## 3.3 可靠传输协议
### 停等协议
- **基本原理**
  - 发送方：发送一个报文段后等待确认
  - 接收方：收到正确报文段后发送ACK
- **ARQ机制**（自动重传请求）
  - 确认方式：ACK（确认）、NAK（否定确认）
  - 改进：ACK携带确认报文段序列号
- **时序图分析**（P101图3.5）
  - 正常传输流程
  - 异常处理：
    - 数据包丢失：超时重传
    - 确认丢失：超时重传
    - 数据出错：丢弃并等待超时
- **信道利用率**
  - 公式：\( U_{Sender} = \frac{t_{Seg}}{t_{Seg} + RTT + t_{ACK}} \)
  - 缺点：信道利用率低，时间浪费在等待确认

### 滑动窗口协议
- **基本改进**
  - 流水线传输：连续发送多个报文段
  - 窗口机制：发送窗口（Ws）、接收窗口（Wr）
- **GBN协议（回退N步）**
  - 发送方：
    - Ws ≥ 1，可连续发送多个分组
    - 超时重传：重发所有已发送未确认分组
    - 累积确认：ACKn表示确认n及之前所有分组
  - 接收方：
    - Wr = 1，仅接收按序到达分组
    - 丢弃失序分组，发送最近正确分组ACK
  - 序号范围：[0, 2^k-1]（k为序号字段位数）
- **SR协议（选择重传）**
  - 发送方：
    - 仅重传超时或NAK的特定分组
    - 每个分组独立计时
  - 接收方：
    - Wr > 1，可缓存失序分组
    - 对每个正确分组发送独立ACK
  - 特点：提高信道利用率，避免不必要重传

## 3.4 UDP协议
- **协议特点**
  - 无连接：无需建立连接
  - 不可靠：不保证交付、不排序、不流量控制
  - 面向数据报：保留报文边界
  - 开销小：首部简单
- **首部格式**（8字节）
  - 源端口号（16位）
  - 目的端口号（16位）
  - 长度（16位）：首部+数据总长度
  - 校验和（16位）：差错检测
- **校验和计算**
  - 伪首部：包含IP首部相关字段
  - 校验范围：伪首部+UDP首部+数据
- **应用场景**
  - 实时应用：视频、语音（容忍丢包）
  - 简单请求响应：DNS查询
  - 广播/多播通信

## 3.5 TCP协议
### 连接管理
- **三次握手（建立连接）**
  1. 客户端→服务器：SYN=1，seq=x
  2. 服务器→客户端：SYN=1，ACK=1，seq=y，ack=x+1
  3. 客户端→服务器：ACK=1，seq=x+1，ack=y+1
- **四次挥手（释放连接）**
  1. 主动方→被动方：FIN=1，seq=u
  2. 被动方→主动方：ACK=1，ack=u+1（半关闭）
  3. 被动方→主动方：FIN=1，seq=v，ack=u+1
  4. 主动方→被动方：ACK=1，seq=u+1，ack=v+1
- **状态转换**
  - 客户端：CLOSED→SYN_SENT→ESTABLISHED→FIN_WAIT_1→FIN_WAIT_2→TIME_WAIT→CLOSED
  - 服务器：CLOSED→LISTEN→SYN_RCVD→ESTABLISHED→CLOSE_WAIT→LAST_ACK→CLOSED

### 报文段格式
- **首部长度**：20字节（基本）~60字节（选项）
- **主要字段**
  - 源端口（16位）/目的端口（16位）
  - 序号（32位）：本报文段第一个字节的编号
  - 确认号（32位）：期望收到的下一字节编号
  - 数据偏移（4位）：首部长度
  - 保留位（6位）
  - 控制位（6位）：
    - URG：紧急指针有效
    - ACK：确认号有效
    - PSH：推送数据
    - RST：重置连接
    - SYN：同步序号
    - FIN：释放连接
  - 窗口大小（16位）：接收方缓存可用空间
  - 校验和（16位）：差错检测
  - 紧急指针（16位）：紧急数据位置

### 流量控制
- **基本原理**：防止发送方速率超过接收方处理能力
- **滑动窗口机制**
  - 接收窗口（rwnd）：接收方告知的缓存大小
  - 发送窗口 ≤ min（拥塞窗口，接收窗口）
  - 窗口滑动：收到确认后移动窗口边界
- **零窗口与窗口探查**
  - 接收方缓存满：发送零窗口通知
  - 发送方：停止发送，定期发送窗口探查报文

### 拥塞控制
- **基本概念**：防止发送方速率超过网络承载能力
- **拥塞窗口（cwnd）**：发送方根据网络状况动态调整
- **慢启动**
  - 初始cwnd=1~4个报文段
  - 每收到一个ACK，cwnd加倍
  - 阈值（ssthresh）：当cwnd=ssthresh时进入拥塞避免
- **拥塞避免**
  - cwnd线性增长（每RTT+1）
  - 检测到超时：ssthresh=cwnd/2，cwnd重置为1，重新慢启动
- **快重传**
  - 收到3个重复ACK，立即重传丢失报文段
  - 不等待超时，减少重传延迟
- **快恢复**
  - ssthresh=cwnd/2，cwnd=ssthresh
  - 进入拥塞避免阶段，cwnd线性增长